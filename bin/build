#!/bin/sh -u

TEXFILE="$1"
BASEFILE="${TEXFILE%.tex}"
DVIFILE="${BASEFILE}.dvi"

CHARSET=`nkf -g "$TEXFILE"`

case "$CHARSET" in
    UTF-8)
        KANJI="utf-8";;
    EUC-JP)
        KANJI="euc-jp";;
    Shift-JIS)
        KANJI="sjis";;
    ISO-2022-JP)
        KANJI="jis";;
    *)
        echo "ERROR: unknown charset: $CHARSET" >&2
        exit 1
        ;;
esac

echo run latex
platex -kanji=$KANJI "$BASEFILE" && :
echo run pbibtex
pbibtex -kanji=$KANJI "$BASEFILE" && :
bibier -kanji=$KANJI "$BASEFILE" && :
echo run latex again
platex -kanji=$KANJI "$BASEFILE" && :
cat main.log
platex -kanji=$KANJI "$BASEFILE" && :
dvipdfmx "$DVIFILE"